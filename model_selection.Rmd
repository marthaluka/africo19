---
title: "Model_selection"
output: html_document
---

## Model selection for SARS-CoV-2 infection waves

### OWID data

I will fit GLMs, GLMM, and GAMs to test which model best fits the data.
Data sources: OWID <https://github.com/owid/covid-19-data> and GISAID <https://www.gisaid.org>.

Load packages 

Read data from OWID

```{r read and pre-process non-mutation data, echo = F, warning=F}

require("pacman")
pacman::p_load(data.table, tidyverse, zoo, RColorBrewer, directlabels, stringr, spData, ggrepel, corrr,
               patchwork, cowplot, egg, here)

owidData0<- read.csv(
  "https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/owid-covid-data.csv",
  fileEncoding="UTF-8-BOM", stringsAsFactors = FALSE
) %>% #select relevant fields 
  dplyr::select(continent, location, date, total_cases, new_cases, total_cases_per_million, 
                new_cases_per_million, total_vaccinations, total_vaccinations_per_hundred, 
                population, stringency_index)

```

Pre-process data:

Biweekly rolling average of cases

Calculate daily continental stringency index (average of country-level). 

Weekly rolling average of stringency index and total vaccinations administerd


```{r data, echo = F, warning=F}
owidData0$date<-as.Date(owidData0$date)


owidData1 <- owidData0 %>%
  filter(new_cases>0) %>%    #drop any negative/zero values ie treat zero as missing data
  dplyr::group_by(location) %>% 
  dplyr::arrange(date) %>% 
  dplyr::mutate(cases_14da = zoo::rollmean(new_cases, k = 14, fill = NA)) %>%   #biweekly rolling mean - for smoothing
  dplyr::mutate(new_smoothed_cases_per_million= (cases_14da/population)*1000000) %>% # smoothed infection rates per 1M
  dplyr::ungroup()

owidData1$date2<-as.Date(cut(owidData1$date,breaks = "2 weeks",start.on.monday = FALSE))
#clean up data. We have both continent-level and country-level entries. 
removeList<-c("World","Africa","Asia", "Oceania", "Africa", "North America", "South America", 
              "Europe", "European Union", "International")  

continentList<-c("Africa","Asia","Oceania","Africa","North America","South America","Europe")

##drop/select for continents#######
owidData2<-subset(owidData1, ! location %in% removeList) #ensure only country-level entries

continentData0<-subset(owidData1, location %in% continentList) %>%   #continent level data
  select(-c(stringency_index)) #drop the country specific stringency field. Recalculate for continent-level below
continentData0$continent<-continentData0$location

###calculate average stringency index per continent and add to continent data#######
contStringency<-owidData2 %>%
  dplyr::select(continent, date, stringency_index)%>%
  mutate_at("stringency_index", ~replace(., is.na(.), 0)) %>% 
  group_by(continent, date) %>% 
  summarise_each(funs(mean))%>% 
  subset(continent %in% continentList)  #drop NAs rows within the continent field

continentData1<-merge(continentData0, contStringency, by=c("continent", "date"), all.x = T)
head(continentData1)

#smooth vaccinations and govt stringency too
continentData2 <- continentData1 %>%
  dplyr::group_by(continent) %>% 
  dplyr::arrange(date) %>% 
  dplyr::mutate(smoothed_stringency_index = zoo::rollmean(stringency_index, k = 7, fill = NA)) %>%   #weekly rolling mean - for smoothing
  dplyr::mutate(smoothed_total_vaccinations_per_hundred = zoo::rollmean(total_vaccinations_per_hundred, k = 7, fill = NA)) %>%   #biweekly rolling mean - for smoothing
  dplyr::ungroup()
```
Visualize to check if all is okay

```{r ggplot, echo = F, warning=F}
ggplot(data=continentData2)+
  #geom_line(aes(x=date, y=new_cases_per_million, colour = "Cases per 1M"))+
  geom_line(aes(x=date, y=smoothed_stringency_index, colour = "Smoothed stringency Index"))+
  geom_line(aes(x=date, y=new_smoothed_cases_per_million, colour = "Smoothed Cases per 1M"))+
  #scale_x_date(date_labels = "%b-%y",date_breaks = "1 month", limits = as.Date(c('2019-12-01','2021-10-01')))+
  facet_wrap(vars(continent))+ ylab(NULL)+
  theme_bw()
```


### GISAID data 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

ggg is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r summary cars}
head(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
